<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Transações (UX Melhorada)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS Integrado (Original + Novas Melhorias) -->
    <style>
        /* Estilos do style.css original */
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0.5;
            cursor: pointer;
        }
        input[type="date"]:invalid::-webkit-datetime-edit {
            color: #9ca3af; /* Cor do placeholder (gray-400) */
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(120deg, #f0f9ff, #e0f2fe, #f0f9ff);
            background-size: 200% 200%;
            animation: gradientAnimation 15s ease infinite;
        }

        .file-upload-label {
            transition: background-color 0.2s ease-in-out;
        }
        .file-upload-label:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .file-name {
            margin-top: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* text-gray-500 */
        }

        /* --- NOVOS ESTILOS PARA MELHORIAS DE UX --- */

        /* Container do Toast (Feedback Visual) */
        #toast-container {
            position: fixed;
            top: 1.25rem; /* top-5 */
            right: 1.25rem; /* right-5 */
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* space-y-3 */
        }

        /* Estilo individual do Toast */
        .toast {
            display: flex;
            align-items: center;
            max-width: 320px; /* max-w-sm */
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            background-color: white; /* bg-white */
            opacity: 0;
            transform: translateX(100%);
            transition: all 400ms cubic-bezier(0.21, 1.02, 0.73, 1); /* Transição suave */
        }

        /* Animação de entrada do Toast */
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* Animação de saída do Toast */
        .toast.hide {
            opacity: 0;
            transform: translateX(100%);
        }

        /* Cores do Toast de Sucesso */
        .toast-success {
            background-color: #10B981; /* bg-green-500 */
            color: white;
        }
        
        /* Estilos de Transição de Seção (Fade/Slide) */
        .section-content, #loginModal, #appContent {
            transition: opacity 300ms ease-out; /* Removido o 'transform' */
        }

        .fade-out {
            opacity: 0;
            /* Removido: transform: translateY(10px); */
            pointer-events: none;
        }

        .fade-in {
            opacity: 1;
            /* Removido: transform: translateY(0); */
        }

        /* Oculta o input de arquivo original */
        #upload-file {
            display: none;
        }

        /* Preview da Imagem */
        #image-preview-container {
            position: relative;
            animation: slideUpFadeIn 400ms ease-out forwards;
        }

        #image-preview {
            display: block;
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }

        /* Botão de Remover Imagem */
        #remove-image-btn {
            position: absolute;
            top: 0.5rem; /* top-2 */
            right: 0.5rem; /* right-2 */
            width: 2rem; /* w-8 */
            height: 2rem; /* h-8 */
            border-radius: 9999px; /* rounded-full */
            background-color: rgba(239, 68, 68, 0.8); /* bg-red-500/80 */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
            transition: all 0.2s ease;
        }
        #remove-image-btn:hover {
            background-color: #EF4444; /* bg-red-500 */
            transform: scale(1.1);
        }

        /* Animação de "slide-up" para o preview */
        @keyframes slideUpFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Container dos Toasts (Notificações) -->
    <div id="toast-container"></div>

    <!-- Modal de Login (Visível por padrão) -->
    <div id="loginModal" class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 sm:p-8 z-50 fade-in">
        <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Login</h2>
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">Usuário</label>
                <input type="text" id="username" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                <input type="password" id="password" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <button id="loginBtn" type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Entrar
            </button>
        </form>
    </div>

    <!-- Conteúdo Principal da Aplicação (Oculto por padrão) -->
    <div id="appContent" class="bg-white w-full max-w-2xl rounded-xl shadow-2xl z-40 hidden opacity-0">
        <!-- Navegação em Abas -->
        <nav class="flex border-b border-gray-200">
            <button id="nav-upload" class="flex-1 py-4 px-6 text-center font-medium text-blue-600 border-b-2 border-blue-600 transition-colors duration-200">
                Upload de Arquivo
            </button>
            <button id="nav-entry" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700 transition-colors duration-200">
                Adicionar Entrada
            </button>
        </nav>

        <!-- Seção de Upload de Arquivo -->
        <div id="upload-section" class="p-6 sm:p-8 section-content fade-in">
            <form id="upload-form" class="space-y-6">
                
                <!-- Nova Seleção de Débito/Crédito -->
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Tipo de Upload</label>
                    <div class="flex items-center space-x-6 rounded-lg border border-gray-300 p-3 bg-gray-50 shadow-sm">
                        <label for="type-debit" class="flex items-center cursor-pointer">
                            <input type="radio" id="type-debit" name="upload-type" value="debit" class="h-4 w-4 text-blue-600 border-gray-400 focus:ring-blue-500" checked>
                            <span class="ml-2 text-sm font-medium text-gray-800">Débito</span>
                        </label>
                        <label for="type-credit" class="flex items-center cursor-pointer">
                            <input type="radio" id="type-credit" name="upload-type" value="credit" class="h-4 w-4 text-red-600 border-gray-400 focus:ring-red-500">
                            <span class="ml-2 text-sm font-medium text-gray-800">Crédito</span>
                        </label>
                    </div>
                </div>

                <!-- Novo Preview de Imagem -->
                <div id="image-preview-container" class="w-full max-w-md mx-auto hidden">
                    <img id="image-preview" src="#" alt="Preview da Imagem" />
                    <button type="button" id="remove-image-btn" aria-label="Remover imagem">
                        <!-- Ícone 'X' -->
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <!-- Área de Upload (Label) -->
                <label id="file-upload-label" for="upload-file" class="file-upload-label w-full cursor-pointer border-2 border-dashed border-gray-300 rounded-lg p-8 text-center block transition-colors duration-200 hover:bg-gray-50">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4V12a4 4 0 014-4h12l4 4h12a4 4 0 014 4zm-4-4V12a4 4 0 00-4-4H16l-4 4H12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <span class="mt-2 block text-sm font-medium text-gray-600">
                        Clique para carregar uma imagem
                    </span>
                    <span class="mt-1 block text-xs text-gray-500">
                        PNG, JPG, GIF até 10MB
                    </span>
                </label>
                <!-- Input de arquivo real (oculto) -->
                <input id="upload-file" name="upload-file" type="file" accept="image/*">

                <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Enviar Arquivo
                </button>
            </form>
        </div>

        <!-- Seção de Adicionar Entrada -->
        <div id="entry-section" class="p-6 sm:p-8 section-content hidden fade-out">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Adicionar Entrada Manual</h3>
            <form id="entry-form" class="space-y-4">
                <div>
                    <label for="entry-valor" class="block text-sm font-medium text-gray-700 mb-1">Valor</label>
                    <input type="number" id="entry-valor" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0,00" required>
                </div>
                <div>
                    <label for="entry-desc" class="block text-sm font-medium text-gray-700 mb-1">Descrição (Opcional)</label>
                    <input type="text" id="entry-desc" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Salário">
                </div>
                <div>
                    <label for="entry-data" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                    <input type="date" id="entry-data" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
               
                <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 mt-4">
                    Adicionar Entrada
                </button>
            </form>
        </div>
    </div>


    <!-- JavaScript Integrado (Original + Novas Melhorias) -->
    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {

            // --- Seletores de Elementos ---
            const loginModal = document.getElementById('loginModal');
            const appContent = document.getElementById('appContent');
            const loginForm = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');

            const navUpload = document.getElementById('nav-upload');
            const navEntry = document.getElementById('nav-entry');
            const uploadSection = document.getElementById('upload-section');
            const entrySection = document.getElementById('entry-section');

            const entryForm = document.getElementById('entry-form');
            const uploadForm = document.getElementById('upload-form');

            // --- NOVO: Seletores para Preview de Imagem ---
            const uploadInput = document.getElementById('upload-file');
            const previewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const removeBtn = document.getElementById('remove-image-btn');
            const uploadLabel = document.getElementById('file-upload-label');


            // --- NOVA: Função de Feedback Visual (Toast) ---
            const toastContainer = document.getElementById('toast-container');

            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.classList.add('toast', type === 'success' ? 'toast-success' : 'toast-error');

                // Ícone (Sucesso ou Erro)
                const icon = `
                    <svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        ${type === 'success' ? 
                            '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : 
                            '<path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
                        }
                    </svg>
                `;
                
                // Mensagem
                const text = `<span class="font-medium">${message}</span>`;
                
                // Botão de Fechar
                const closeBtn = document.createElement('button');
                closeBtn.classList.add('toast-close-btn');
                closeBtn.setAttribute('aria-label', 'Fechar');
                closeBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>';
                
                toast.innerHTML = icon + text;
                toast.appendChild(closeBtn);
                
                // Adiciona ao container
                toastContainer.appendChild(toast);

                // Animação de entrada
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });

                // Remover o toast (automaticamente ou ao clicar)
                const removeToast = () => {
                    toast.classList.remove('show');
                    toast.classList.add('hide');
                    // Remove do DOM após a animação de saída
                    setTimeout(() => {
                        toastContainer.removeChild(toast);
                    }, 400);
                };

                closeBtn.addEventListener('click', removeToast);
                setTimeout(removeToast, 4000); // Auto-dismiss after 4 seconds
            }

            // --- Helper para converter arquivo para Base64 ---
            function toBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }


            // --- Lógica do Modal de Login (Atualizada com Transições e Toast) ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginBtn.disabled = true;
                loginBtn.textContent = 'Entrando...';

                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: username,
                            password: password
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.ok) {
                        // Sucesso no login
                        showToast(data.message || 'Login bem-sucedido!', 'success');
                        
                        // Animação de saída do modal
                        loginModal.classList.add('fade-out');
                        
                        setTimeout(() => {
                            loginModal.classList.add('hidden');
                            
                            // Animação de entrada do app
                            appContent.classList.remove('hidden');
                            requestAnimationFrame(() => {
                                 appContent.classList.remove('opacity-0');
                                 appContent.classList.add('fade-in');
                            });
                           
                        }, 300); // Tempo da animação de fade-out
                    } else {
                        // Erro retornado pela API
                        throw new Error(data.error || 'Usuário ou senha inválidos.');
                    }

                } catch (error) {
                    // Erro de rede, JSON ou da API
                    showToast(error.message, 'error');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Entrar';
                }
            });

            // --- Lógica de Navegação (Atualizada com Transições e Correção de Bug) ---
            function showSection(sectionId) {
                const sections = [uploadSection, entrySection];
                const navs = [navUpload, navEntry];
                const activeNav = (sectionId === 'upload-section') ? navUpload : navEntry;
                const activeSection = (sectionId === 'upload-section') ? uploadSection : entrySection;

                // Encontra a seção ativa atual (que não está 'hidden')
                const currentActiveSection = sections.find(s => !s.classList.contains('hidden'));

                if (currentActiveSection === activeSection) {
                    return; // Já está na seção correta, não faz nada
                }

                // Esconde a seção atual (se houver uma)
                if (currentActiveSection) {
                    currentActiveSection.classList.remove('fade-in');
                    currentActiveSection.classList.add('fade-out');
                    
                    // Espera a animação de fade-out (300ms) terminar
                    setTimeout(() => {
                        currentActiveSection.classList.add('hidden');
                        
                        // Agora, mostra a nova seção
                        activeSection.classList.remove('hidden');
                        activeSection.classList.remove('fade-out'); // Garante que está limpo
                        requestAnimationFrame(() => {
                            // Adiciona a classe de fade-in para a nova seção aparecer
                            activeSection.classList.add('fade-in');
                        });
                        
                    }, 300); // Deve ser igual ao tempo da transição no CSS
                } else {
                    // Se nenhuma seção estiver ativa (carregamento inicial, embora já tratado)
                    activeSection.classList.remove('hidden');
                    activeSection.classList.add('fade-in');
                }

                // Atualiza o estilo das abas (pode ser imediato)
                navs.forEach(nav => {
                    nav.classList.remove('text-blue-600', 'border-blue-600');
                    nav.classList.add('text-gray-500', 'hover:text-gray-700');
                });
                activeNav.classList.add('text-blue-600', 'border-blue-600');
                activeNav.classList.remove('text-gray-500', 'hover:text-gray-700');
            }

            navUpload.addEventListener('click', () => showSection('upload-section'));
            navEntry.addEventListener('click', () => showSection('entry-section'));


            // --- Lógica do Formulário de Entrada (Atualizada com Toast) ---
            entryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = entryForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.textContent;
                
                const valorRaw = document.getElementById('entry-valor').value;
                const data = document.getElementById('entry-data').value;
                const desc = document.getElementById('entry-desc').value;

                if (!valorRaw || !data) {
                    showToast('Os campos Valor e Data são obrigatórios.', 'error');
                    return;
                }
                
                // Converte "1234.56" para 1234.56
                const valor = parseFloat(valorRaw);

                if (isNaN(valor) || valor <= 0) {
                    showToast('Por favor, insira um valor válido.', 'error');
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = 'Adicionando...';

                try {
                    const response = await fetch('/api/salary', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ valor, data, desc })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Erro ao adicionar entrada.');
                    }

                    showToast('Entrada adicionada com sucesso!', 'success');
                    entryForm.reset();

                } catch (error) {
                    showToast(`Erro: ${error.message}`, 'error');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            });


            // --- NOVA: Lógica de Preview de Imagem ---
            uploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        imagePreview.src = event.target.result;
                        previewContainer.classList.remove('hidden'); // Mostra o preview
                        uploadLabel.classList.add('hidden'); // Esconde a label de upload
                    };
                    
                    reader.readAsDataURL(file);
                } else if (file) {
                    // Se não for imagem
                    showToast('Por favor, selecione um arquivo de imagem.', 'error');
                    uploadInput.value = null; // Limpa o input
                }
            });

            // --- NOVA: Lógica para Remover Imagem ---
            removeBtn.addEventListener('click', () => {
                uploadInput.value = null; // Limpa o input de arquivo
                imagePreview.src = '#'; // Limpa a imagem
                previewContainer.classList.add('hidden'); // Esconde o preview
                uploadLabel.classList.remove('hidden'); // Mostra a label de upload
            });
            
            // --- Lógica de Envio de Upload (Atualizada com Débito/Crédito) ---
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = uploadForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.textContent;
                
                const file = uploadInput.files[0];
                if (!file) {
                    showToast('Por favor, selecione uma imagem para enviar.', 'error');
                    return;
                }

                const selectedType = document.querySelector('input[name="upload-type"]:checked').value;
                const apiUrl = (selectedType === 'debit') ? '/api/debit' : '/api/credit';
                
                submitButton.disabled = true;
                submitButton.textContent = 'Enviando...';
                
                try {
                    const base64Data = await toBase64(file);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            data: base64Data,
                            filename: file.name,
                            // O endpoint de crédito pode precisar de um 'card', mas o form atual não tem.
                            // Se necessário, adicione um campo de seleção de cartão ao formulário.
                            card: 'default' // Valor padrão, ajuste se necessário
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Falha no upload');
                    }
                    
                    showToast(`Upload (${selectedType}) bem-sucedido!`, 'success');
                    
                    removeBtn.click(); // Limpa o formulário
                    
                } catch (error) {
                    showToast(`Erro no upload: ${error.message}`, 'error');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            });

        });
    </script>
</body>
</html>
``` 